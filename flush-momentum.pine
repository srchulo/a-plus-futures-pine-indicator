//@version=5
indicator("Flush Momentum", shorttitle="FlushMomentum", overlay=false, max_bars_back=5000)

// FlushMomentum model params (KEEP IN SYNC IN BOTH SCRIPTS)
// len1=40, len2=105, len3=170
// a0=-0.016711, a1=0.050736, a2=0.049021, a3=-0.092770, k=0.913499

// === Inputs ===
src   = input.source(close, "Source")
len1  = input.int(40,  "Fast EMA length")
len2  = input.int(105, "Mid EMA length")
len3  = input.int(170, "Slow EMA length")

// Recurrent model coefficients (fit from your export)
// osc_t ≈ a0 + a1*(close-EMA1)_t + a2*(EMA1-EMA2)_t + a3*(EMA2-EMA3)_t + k*osc_{t-1}
a0 = input.float(-0.016711, "Bias")
a1 = input.float( 0.050736, "Coef: close - EMA1")
a2 = input.float( 0.049021, "Coef: EMA1 - EMA2")
a3 = input.float(-0.092770, "Coef: EMA2 - EMA3")
k  = input.float( 0.913499, "Recurrent weight")

// === Thresholds & auto symbol logic ===
// Base manual thresholds (used for "Other" or when auto is off)
manualStrongThresh = input.float(1.5, "Strong magnitude threshold (manual)")
manualWeakThresh   = input.float(0.6, "Neutral zone half-width (manual)")
trendLookback      = input.int(5, "Trend lookback (bars)", minval=1)

// Turn on/off symbol-based auto thresholds
useAutoBySymbol    = input.bool(true, "Auto thresholds by symbol")

// Detect some common symbols
isMNQ = str.startswith(syminfo.ticker, "MNQ")
isMES = str.startswith(syminfo.ticker, "MES")
isMicroIndex = isMNQ or isMES

isBTC = str.contains(syminfo.ticker, "BTC")
isETH = str.contains(syminfo.ticker, "ETH")
isSOL = str.contains(syminfo.ticker, "SOL")
isMajorCrypto = isBTC or isETH or isSOL

// Effective thresholds (used everywhere below)
float strongThresh = na
float weakThresh   = na

if useAutoBySymbol
    // Futures-style defaults (MNQ / MES) – more “spread out”
    if isMicroIndex
        strongThresh := 2.0
        weakThresh   := 0.8
    // Crypto majors (BTC / ETH / SOL) – tighter since osc is typically smaller range
    else if isMajorCrypto
        strongThresh := 0.8
        weakThresh   := 0.3
    // Fallback to manual for everything else
    else
        strongThresh := manualStrongThresh
        weakThresh   := manualWeakThresh
else
    // Purely manual mode
    strongThresh := manualStrongThresh
    weakThresh   := manualWeakThresh

// (Optional) expose effective thresholds in Data Window (hidden on chart)
plot(strongThresh, "StrongThresholdEffective", display=display.none)
plot(weakThresh,   "WeakThresholdEffective",   display=display.none)

// === Core EMAs ===
ema1 = ta.ema(src, len1)
ema2 = ta.ema(src, len2)
ema3 = ta.ema(src, len3)

// === Derived spreads ===
c_e1  = src  - ema1
e1_e2 = ema1 - ema2
e2_e3 = ema2 - ema3

// === Recurrent oscillator ===
// base (new info this bar)
base_step = a0 + a1 * c_e1 + a2 * e1_e2 + a3 * e2_e3

// osc_t = base_step + k * osc_{t-1}
var float osc = na
osc := na(osc[1]) ? base_step : base_step + k * osc[1]

// === State logic ===
isStrongPos = osc >  strongThresh
isStrongNeg = osc < -strongThresh
isNeutral   = math.abs(osc) <= weakThresh

slopeUp   = osc > osc[1]
slopeDown = osc < osc[1]

// Trend quality over last N bars
trendUp   = ta.sma(osc >  weakThresh ? 1.0 : 0.0, trendLookback) >= 1.0
trendDown = ta.sma(osc < -weakThresh ? 1.0 : 0.0, trendLookback) >= 1.0

// === Coloring (green when rising, red when falling, gray neutral) ===
col = isNeutral ? color.new(color.gray, 40) :
      slopeUp   ? color.new(color.lime, 0)  :
      slopeDown ? color.new(color.red, 0)   :
                  color.new(color.gray, 40)

// === Background fill for sustained momentum trend ===
bgCol = trendUp   ? color.new(color.green, 85) : trendDown ? color.new(color.red,   85) : na
bgcolor(bgCol)

// === Plots ===
plot(osc, color=col, linewidth=3, title="FlushMomentum")
plot(0,   color=color.new(color.white, 70), linewidth=2, title="Zero")

// === Strong-momentum shift signals ===
bullShift = isStrongPos and not isStrongPos[1] and slopeUp
bearShift = isStrongNeg and not isStrongNeg[1] and slopeDown

plotchar(bullShift, "Strong Bullish Momentum", "▲",
         location=location.bottom, color=color.lime, size=size.tiny)
plotchar(bearShift, "Strong Bearish Momentum", "▼",
         location=location.top,    color=color.red,  size=size.tiny)

// === Alerts ===
alertcondition(bullShift, "Strong bullish momentum",
               "FlushMomentum: strong bullish momentum")
alertcondition(bearShift, "Strong bearish momentum",
               "FlushMomentum: strong bearish momentum")
